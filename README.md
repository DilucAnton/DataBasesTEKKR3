# DataBasesTEKKR3




## ШАГ 1. Создание таблицы ОПИСАНИЕ_ОБЪЕКТА_XML

<img width="604" height="433" alt="Снимок экрана 2025-12-18 в 10 40 34" src="https://github.com/user-attachments/assets/54a89770-e011-48fb-ba54-f03b0cbdab55" />

## ШАГ 2. Создание таблицы «Динамика цен»

<img width="538" height="224" alt="Снимок экрана 2025-12-18 в 10 42 02" src="https://github.com/user-attachments/assets/a7b98214-4765-4730-bd5d-4e5595e36cd2" />

## ШАГ 3. Заполним таблицу «Динамика цен» тестовыми данными

<img width="661" height="223" alt="Снимок экрана 2025-12-18 в 10 42 43" src="https://github.com/user-attachments/assets/6127ac97-826b-46ec-993d-b744bb8c41ec" />

## ШАГ 4. Создание процедуры заполнения XML
 Логика процедуры 
```
Процедура должна:

Очистить таблицу ОПИСАНИЕ_ОБЪЕКТА_XML

Для каждого объекта недвижимости:

собрать данные из:

Объект недвижимости

Районы

ОПИСАНИЕ ОБЪЕКТА (JSON → площади)

Динамика цен

определить рейтинг квартиры в районе

самая дорогая квартира → рейтинг 1

сформировать XML по заданной структуре

Вставить результат в таблицу
```
<img width="2368" height="1452" alt="image" src="https://github.com/user-attachments/assets/0f1c9935-2f8b-4f6e-b541-ce20d9af3ef6" />
<img width="2302" height="650" alt="image" src="https://github.com/user-attachments/assets/aa1cf70c-6d44-4834-b8ce-eb9c58935dee" />


## ШАГ 5. Вызов процедуры

<img width="930" height="848" alt="image" src="https://github.com/user-attachments/assets/efdbe85d-e718-46fb-942d-7a3ba6c7c059" />
<br>
<img width="1331" height="348" alt="Снимок экрана 2025-12-18 в 10 58 44" src="https://github.com/user-attachments/assets/1560e0ba-3a9f-4f53-873e-a25396673f4f" />


## Запросы к XML

## 3.1. Адреса (улица, дом, квартира) объектов в указанном районе
<img width="1015" height="442" alt="Снимок экрана 2025-12-18 в 10 59 35" src="https://github.com/user-attachments/assets/820030b9-c7ec-483b-9063-c97077fcd446" />

```
Объяснение:

Выбирает улицу, номер дома и квартиры объектов из указанного района (Центральный в примере).

xpath('//Ulitsa/text()') извлекает текст из тега <Ulitsa> внутри каждого <object>.

Фильтр по Nazvanie_raiona позволяет выбрать только объекты нужного района.

Сортировка по дому и квартире упрощает просмотр адресов.

Результат: список всех адресов объектов недвижимости в конкретном районе.
```
## 3.2. Объекты указанной области, где жилая ≥ 60% от общей

<img width="849" height="690" alt="Снимок экрана 2025-12-18 в 11 05 38" src="https://github.com/user-attachments/assets/ea3bad8a-ddbf-4d74-bcac-62ba24148a65" />

```
Объяснение:

Разбирает каждый <object> с помощью xmltable() в табличный вид.

Извлекает город, улицу, дом, квартиру, общую и жилую площадь, область.

Фильтр по Область = 'Россия' выбирает только объекты в России.

Условие Zhilaya_ploshchad >= 60% * Obshchaya_ploshchad позволяет найти объекты, где жилая площадь достаточно большая.

trim() и ::int приводят текст из XML к числу.

Результат: объекты с жилой площадью ≥ 60% от общей площади.
```
## 3.3. Район, адрес и рейтинг объектов

<img width="802" height="598" alt="Снимок экрана 2025-12-18 в 11 02 05" src="https://github.com/user-attachments/assets/ad0e4d3d-db78-43b6-bb9c-012d85b7b58a" />

```
Объяснение:

Для каждого объекта извлекаем: район, адрес (улица + дом + квартира) и рейтинг.

Рейтинг формировался в процедуре fill_object_xml() как позиция объекта в цене среди района (самая дорогая квартира → рейтинг 1).

Используем xmltable() для удобного разбора XML.

Результат: список объектов с адресами и рейтингом по району, упорядоченный по району и рейтингу.
```
## 3.4. Динамика изменения стоимости объекта
<img width="1016" height="442" alt="Снимок экрана 2025-12-18 в 11 00 25" src="https://github.com/user-attachments/assets/21269e0f-cc42-4bfa-9d5b-cbd0625d2001" />
```
```
Объяснение:

Извлекает все теги <Stoimost> для конкретного объекта (код 1).

unnest() превращает массив XML-элементов в строки таблицы.

В каждой строке содержится: стоимость и дата установки.

Можно использовать для анализа динамики цен: смотреть, как менялась стоимость объекта с течением времени.

Результат: список всех изменений стоимости объекта с указанием даты.
```


## Процедура update_owner

<img width="747" height="661" alt="Снимок экрана 2025-12-18 в 11 08 18" src="https://github.com/user-attachments/assets/e2dd7a06-463a-4b5e-93c8-7b83b854da0f" />

```
Аргументы процедуры:

p_object_id — код объекта, которому хотим назначить собственника.

p_owner_name — ФИО нового собственника.

Обновляем таблицу "Объект недвижимости":

Меняем значение в поле "Собственник" на новое.

Обновляем JSON-поле в "ОПИСАНИЕ ОБЪЕКТА":

Используем jsonb_set() для изменения ключа "Собственник" в JSON.

Аргумент true создаёт ключ, если он отсутствует.

Обновляем XML-таблицу:

Вызываем fill_object_xml() — пересоздаём XML с новым ФИО.

Теперь при запросах 3.1–3.4 будет отображаться обновлённый собственник.
```

Пример использования

```
-- Назначаем ФИО "Сидоров С.С." объекту с кодом 2
CALL update_owner(2, 'Сидоров С.С.');
```
После этого:

В таблице "Объект недвижимости" для объекта 2 будет "Собственник" = 'Сидоров С.С.'.

В JSON-поле "Описание" обновится ключ "Собственник".

В XML (таблица "ОПИСАНИЕ_ОБЪЕКТА_XML") новый собственник тоже появится.

##

##
